{% extends 'storage_rental/base.html' %}
{% load static %}

{% block header %}
<script src="https://unpkg.com/react@17/umd/react.production.min.js"
    crossorigin></script>
<script src="https://unpkg.com/react-dom@17/umd/react-dom.production.min.js"
    crossorigin></script>
<script src="https://unpkg.com/babel-standalone@6/babel.min.js"></script>
<title>Self Storage - Сезонное хранение</title>
{% endblock %}

{% block content %}
<div class="container">
    <br>
    <h1>Сезонное хранение</h1>
    <br>
    <form method="post">
        {% csrf_token %}
        {{ form.as_p }}
        <button class="btn btn-outline-dark" type="submit">Сдать на
            хранение</button>
    </form>

    <div id="app" width="100%"></div>

    <br>

    <p>Выбранный инвентарь</p>
    <img width="400px;" height="400px;" id="item_img"/>

    <script type="text/babel">

        const App = () => {
            const all_items = JSON.parse("{{ items|escapejs }}");

            const [selectedItem, setSelectedItem] = React.useState();
            const [duration, setDuration] = React.useState(1);
            const [quantity, setQuantity] = React.useState(1);
            const [totalPrice, setTotalPrice] = React.useState(0);

            React.useEffect(() => {
                let item = all_items[selectedItem]
                if (item) {
                    let week_price = item.week_storage_price
                    let month_price = item.month_storage_price

                    duration < 4
                        ? setTotalPrice(quantity * duration * week_price)
                        : setTotalPrice(quantity * Math.floor(duration / 4) * month_price)

                    imageEl.style.display = 'block';
                    imageEl.setAttribute('src', item.image)
                }
                else {
                    setTotalPrice(0)
                    imageEl.style.display = 'none';
                }
            }, [selectedItem, duration, quantity]);

            let imageEl = document.querySelector("#item_img");

            const itemEl = document.querySelector("#item");
            itemEl.addEventListener("change", () => {
                setSelectedItem(itemEl.value);
            });

            const durationEl = document.querySelector("#duration");
            durationEl.addEventListener("change", () => {
                setDuration(durationEl.value || 0)
            });

            const quantityEl = document.querySelector("#quantity");
            quantityEl.addEventListener("change", () => {
                setQuantity(quantityEl.value || 0)
            });

            return (
                <div>
                    <strong><p class="mt-3">Итоговая сумма: {totalPrice}</p></strong>
                </div>
            );
        }

        ReactDOM.render(<App />, document.querySelector("#app"));
    </script>
</div>


{% endblock %}